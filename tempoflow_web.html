<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Timer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, sans-serif; }
        body { background: #1e1e2e; color: #cdd6f4; min-height: 100vh; display: flex; flex-direction: column; }
        #global-timer { font-size: clamp(4rem, 15vw, 10rem); text-align: center; padding: 20px; background: linear-gradient(135deg, #89b4fa, #74c7ec); -webkit-background-clip: text; background-clip: text; color: transparent; }
        #sections { flex: 1; max-height: 60vh; overflow-y: auto; padding: 20px; }
        .section { padding: 20px; margin: 10px; border-radius: 12px; cursor: pointer; transition: all 0.3s; position: relative; }
        .section.upcoming { background: #313244; border: 2px solid #45475a; }
        .section.active { background: #a6e3a1; color: #1e1e2e; border: 3px solid #89b4fa; transform: scale(1.02); }
        .section.completed { background: #f9e2af; color: #1e1e2e; text-decoration: line-through; opacity: 0.7; }
        .section.completed::before { content: '‚úî '; font-size: 1.5em; color: #a6e3a1; }
        .section-timer { font-size: 1.5rem; font-weight: bold; margin-top: 10px; }
        #controls { padding: 20px; display: flex; gap: 10px; justify-content: center; background: #313244; }
        button { padding: 12px 24px; border: none; border-radius: 8px; background: #89b4fa; color: white; cursor: pointer; font-size: 1rem; }
        button:hover { background: #74c7ec; }
        #edit-form { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; place-items: center; }
        #edit-form.show { display: grid; }
        .dialog { background: white; color: black; padding: 40px; border-radius: 20px; max-width: 500px; text-align: center; }
        @keyframes flash { 0%,100%{ background: currentColor; } 50%{ background: #f38ba8; } }
        .alert { animation: flash 0.5s; }
        #confirm-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #1e1e2e; color: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 200; display: none; }
        #confirm-dialog.show { display: block; }
    </style>
</head>
<body>
    <div id="global-timer">90:00</div>
    <div id="status">–£—Ä–æ–∫ –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É</div>
    <div id="sections"></div>
    <div id="controls">
        <button onclick="editSections()">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button onclick="resetAll()">üîÑ –°–±—Ä–æ—Å</button>
        <button onclick="toggleFullscreen()">üì± –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
    </div>

    <div id="edit-form">
        <div class="dialog">
            <h2>–°–µ–∫—Ü–∏–∏ —É—Ä–æ–∫–∞</h2>
            <div id="edit-sections"></div>
            <button onclick="addSection()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="saveSections()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="closeEdit()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="confirm-dialog">
        <h3>–°–µ–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h3>
        <p id="confirm-msg"></p>
        <button onclick="confirmNext(true)">–î–∞, —Å–ª–µ–¥—É—é—â–∞—è</button>
        <button onclick="confirmNext(false)">–ù–µ—Ç</button>
    </div>

    <script>
        let sections = [
            {id: 1, title: '–í–≤–µ–¥–µ–Ω–∏–µ', durationMs: 5*60*1000, remainingMs: 5*60*1000, completed: false},
            {id: 2, title: '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —É—á–µ–Ω–∏–∫–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è', durationMs: 3*60*1000, remainingMs: 3*60*1000, completed: false},
            {id: 3, title: '–ö—Ä–∞—Ç–∫–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ —É—Ä–æ–∫–∞', durationMs: 2*60*1000, remainingMs: 2*60*1000, completed: false}
            // Add more...
        ];
        let totalRemainingMs = 90 * 60 * 1000;
        let globalInterval = null;
        let sectionInterval = null;
        let activeSectionId = null;
        let audioCtx = null;

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function beep(freq=800, dur=300) {
            if (!audioCtx) initAudio();
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.value = freq; o.type = 'sine';
            g.gain.setValueAtTime(0.3, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur/1000);
            o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + dur/1000);
        }

        function formatTime(ms) {
            const m = Math.floor(ms / 60000), s = Math.floor((ms % 60000) / 1000);
            return `${m.toString().padStart(2,0)}:${s.toString().padStart(2,0)}`;
        }

        function updateGlobal() {
            document.getElementById('global-timer').textContent = formatTime(totalRemainingMs);
            if (totalRemainingMs <= 0) {
                clearInterval(globalInterval);
                document.getElementById('status').textContent = '–£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω!';
                beep(400, 1000);
                if (sections.every(s => s.completed)) showSummary();
            }
        }

        function updateSections() {
            const cont = document.getElementById('sections');
            cont.innerHTML = sections.map(s => {
                const state = s.completed ? 'completed' : (s.id === activeSectionId ? 'active' : 'upcoming');
                return `<div class="section ${state}" onclick="${!s.completed ? `startSection(${s.id})` : ''}" role="button" tabindex="0">
                    <div>${s.title}</div>
                    <div class="section-timer">${formatTime(s.remainingMs)}</div>
                </div>`;
            }).join('');
            const completedCount = sections.filter(s => s.completed).length;
            document.getElementById('status').textContent = `${completedCount}/${sections.length} –∑–∞–≤–µ—Ä—à–µ–Ω–æ | –ê–∫—Ç–∏–≤–Ω–∞: ${activeSectionId ? sections.find(s => s.id === activeSectionId)?.title || '–ù–µ—Ç' : '–ù–µ—Ç'}`;
        }

        function startGlobal() {
            if (globalInterval) return;
            globalInterval = setInterval(() => {
                totalRemainingMs = Math.max(0, totalRemainingMs - 1000);
                updateGlobal();
            }, 1000);
        }

        function startSection(id) {
            const sec = sections.find(s => s.id === id);
            if (!sec || sec.completed) return;
            activeSectionId = id;
            if (sectionInterval) clearInterval(sectionInterval);
            startGlobal();
            sectionInterval = setInterval(() => {
                sec.remainingMs = Math.max(0, sec.remainingMs - 1000);
                updateSections();
                if (sec.remainingMs <= 0) {
                    clearInterval(sectionInterval);
                    sec.completed = true;
                    totalRemainingMs = Math.max(0, totalRemainingMs - sec.durationMs + sec.remainingMs); // Adjust global
                    beep(1200, 500);
                    document.body.classList.add('alert');
                    setTimeout(() => document.body.classList.remove('alert'), 500);
                    showConfirmNext(id);
                    updateSections();
                }
            }, 1000);
            updateSections();
        }

        function showConfirmNext(currentId) {
            const nextSec = sections.find(s => !s.completed && s.id > currentId);
            document.getElementById('confirm-msg').textContent = nextSec ? `–ó–∞–ø—É—Å—Ç–∏—Ç—å "${nextSec.title}"?` : '–í—Å–µ —Å–µ–∫—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã!';
            document.getElementById('confirm-dialog').classList.add('show');
        }

        window.confirmNext = (yes) => {
            document.getElementById('confirm-dialog').classList.remove('show');
            if (yes) {
                const currentId = activeSectionId;
                const nextId = sections.find(s => !s.completed && s.id > currentId)?.id;
                if (nextId) startSection(nextId);
            }
            activeSectionId = null;
        };

        function editSections() {
            document.getElementById('edit-form').classList.add('show');
            renderEdit();
        }

        function renderEdit() {
            document.getElementById('edit-sections').innerHTML = sections.map((s, i) => `
                <div style="display:flex;gap:10px;margin:10px 0;">
                    <input value="${s.title}" onchange="sections[${i}].title=this.value">
                    <input type="number" value="${s.durationMs/60000}" onchange="updateDuration(${i},this.value)" min="1">
                    <button onclick="sections.splice(${i},1);renderEdit();updateTotal()">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }

        function updateDuration(i, mins) {
            const sec = sections[i];
            sec.durationMs = mins * 60000;
            sec.remainingMs = sec.durationMs;
            updateTotal();
        }

        function addSection() {
            const newId = Math.max(...sections.map(s=>s.id)) + 1;
            sections.push({id: newId, title: '–ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è', durationMs: 5*60000, remainingMs: 5*60000, completed: false});
            renderEdit();
            updateTotal();
        }

        function updateTotal() {
            totalRemainingMs = sections.reduce((sum, s) => sum + s.durationMs * !s.completed, 0);
        }

        function saveSections() {
            localStorage.setItem('lessonSections', JSON.stringify(sections));
            document.getElementById('edit-form').classList.remove('show');
            updateSections();
            updateTotal();
            updateGlobal();
        }

        function closeEdit() {
            document.getElementById('edit-form').classList.remove('show');
            loadState();
        }

        function resetAll() {
            sections.forEach(s => { s.completed = false; s.remainingMs = s.durationMs; });
            clearInterval(globalInterval);
            clearInterval(sectionInterval);
            activeSectionId = null;
            totalRemainingMs = sections.reduce((sum, s) => sum + s.durationMs, 0);
            localStorage.removeItem('lessonSections');
            updateSections();
            updateGlobal();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        function showSummary() {
            alert(`–£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω!\n–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${sections.length}/${sections.length}\n–û–±—â–µ–µ –≤—Ä–µ–º—è: ${formatTime(90*60000 - totalRemainingMs)}`);
        }

        function loadState() {
            const saved = localStorage.getItem('lessonSections');
            if (saved) sections = JSON.parse(saved);
        }

        // Init
        loadState();
        updateTotal();
        updateSections();
        updateGlobal();

        // Voice (optional)
        if ('speechSynthesis' in window) {
            speechSynthesis.lang = 'ru-RU';
        }

        // Keyboard
        document.addEventListener('keydown', e => {
            if (e.code === 'Escape') closeEdit();
        });
    </script>
</body>
</html>
